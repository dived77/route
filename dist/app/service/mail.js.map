{"version":3,"sources":["../../../app/service/mail.js"],"names":["Service","require","mailer","sgMail","MailService","data","config","logger","debug","setApiKey","mail_grid_opts","auth","api_key","i","send","info","error","Error","who","token","name","from","mail_opts","user","to","subject","html","String","console","log","sendMail","host","module","exports"],"mappings":";;;;;;;;;;;;AACA,IAAMA,UAAUC,QAAQ,KAAR,EAAeD,OAA/B;AACA,IAAME,SAASD,QAAQ,YAAR,CAAf;AACA;AACA;AACA,IAAME,SAASF,QAAQ,gBAAR,CAAf;;IAEMG,W;;;;;;;;;;;;gGACaC,I;;;;;;AACHC,sC,GAAmB,I,CAAnBA,M,EAAQC,M,GAAW,I,CAAXA,M;;qCAEZD,OAAOE,K;;;;;;;;;AAIXL,uCAAOM,SAAP,CAAiBH,OAAOI,cAAP,CAAsBC,IAAtB,CAA2BC,OAA5C;;AAESC,iC,GAAI,C;;;sCAAGA,IAAI,C;;;;;;;uCAENV,OAAOW,IAAP,CAAYT,IAAZ,C;;;AACNE,uCAAOQ,IAAP,CAAY,mBAAZ,EAAiCV,IAAjC;;;;;;;sCAGIQ,MAAM,C;;;;;AACNN,uCAAOS,KAAP,CAAa,yBAAb,eAA6CX,IAA7C;sCACM,IAAIY,KAAJ,a;;;AAEVV,uCAAOS,KAAP,CAAa,iBAAb,eAAqCX,IAArC;;;AAVeQ,mC;;;;;;;;;;;;;;;;;;;;;kGAeNK,G,EAAKC,K;;;;;;AACdb,sC,GAAW,I,CAAXA,M;AACFc,oC,GAAO,O;AACPC,oC,GAAUf,OAAOc,I,UAASd,OAAOgB,SAAP,CAAiBX,IAAjB,CAAsBY,I;AAChDC,kC,GAAKN,G;AACLO,uC,GAAUnB,OAAOc,IAAP,GAAc,Q;AACxBM,oC,GAAOC,OAAO,WAAWP,IAAX,GAAkB,MAAlB,GACxB,WADwB,GACVd,OAAOc,IADG,GACI,4BADJ,GAExB,MAFwB,GAEfD,KAFQ,IAGjB,UAHiB,GAGJb,OAAOc,IAHH,GAGU,oDAHV,GAIjB,KAJiB,GAITd,OAAOc,IAJE,GAIK,Y;;;AAElBQ,wCAAQC,GAAR,CAAYH,IAAZ;;uCACM,KAAKI,QAAL,CAAc;AAChBT,8CADgB;AAEhBG,0CAFgB;AAGhBC,oDAHgB;AAIhBC;AAJgB,iCAAd,C;;;;;;;;;;;;;;;;;;;kGAScR,G,EAAKC,K,EAAOC,I;;;;;;AACxBd,sC,GAAW,I,CAAXA,M;AACFe,oC,GAAUf,OAAOc,I,UAASd,OAAOgB,SAAP,CAAiBX,IAAjB,CAAsBY,I;AAChDC,kC,GAAKN,G;AACLO,uC,GAAUnB,OAAOc,IAAP,GAAc,Q;AACxBM,oC,GAAO,WAAWN,IAAX,GAAkB,MAAlB,GACjB,WADiB,GACHd,OAAOc,IADJ,GACW,oCADX,GAEjB,WAFiB,GAEHd,OAAOyB,IAFJ,GAEW,kBAFX,GAEgCZ,KAFhC,GAEwC,QAFxC,GAEmDC,IAFnD,GAE0D,cAF1D,GAGjB,UAHiB,GAGJd,OAAOc,IAHH,GAGU,oDAHV,GAIjB,KAJiB,GAITd,OAAOc,IAJE,GAIK,Y;;uCAEZ,KAAKU,QAAL,CAAc;AAChBT,8CADgB;AAEhBG,0CAFgB;AAGhBC,oDAHgB;AAIhBC;AAJgB,iCAAd,C;;;;;;;;;;;;;;;;;;;EA1DY1B,O;;AAmE1BgC,OAAOC,OAAP,GAAiB7B,WAAjB","file":"mail.js","sourcesContent":["\nconst Service = require('egg').Service;\nconst mailer = require('nodemailer');\n// const smtpTransport = require('nodemailer-smtp-transport');\n// const sgTransport = require('nodemailer-sendgrid-transport');\nconst sgMail = require('@sendgrid/mail');\n\nclass MailService extends Service {\n    async sendMail(data) {\n        const { config, logger } = this;\n\n        if (config.debug) {\n            return;\n        }\n\n        sgMail.setApiKey(config.mail_grid_opts.auth.api_key);\n\n        for (let i = 1; i < 6; i++) {\n            try {\n                await sgMail.send(data);\n                logger.info('send mail success', data);\n                break;\n            } catch (err) {\n                if (i === 5) {\n                    logger.error('send mail finally error', err, data);\n                    throw new Error(err);\n                }\n                logger.error('send mail error', err, data);\n            }\n        }\n    }\n\n    async sendActiveMail(who, token) {\n        const { config } = this;\n        const name = 'miner';\n        const from = `${config.name} <${config.mail_opts.auth.user}>`;\n        const to = who;\n        const subject = config.name + '社区帐号激活';\n        const html = String('<p>您好：' + name + '</p>' +\n    '<p>我们收到您在' + config.name + '社区的注册信息，请点击下面的链接来激活帐户：</p>' +\n    '验证码:' + token) +\n    '<p>若您没有在' + config.name + '社区填写过注册信息，说明有人滥用了您的电子邮箱，请删除此邮件，我们对给您造成的打扰感到抱歉。</p>' +\n    '<p>' + config.name + '社区 谨上。</p>';\n\n        console.log(html);\n        await this.sendMail({\n            from,\n            to,\n            subject,\n            html\n        });\n    }\n\n\n    async sendResetPassMail(who, token, name) {\n        const { config } = this;\n        const from = `${config.name} <${config.mail_opts.auth.user}>`;\n        const to = who;\n        const subject = config.name + '社区密码重置';\n        const html = '<p>您好：' + name + '</p>' +\n    '<p>我们收到您在' + config.name + '社区重置密码的请求，请在24小时内单击下面的链接来重置密码：</p>' +\n    '<a href=\"' + config.host + '/reset_pass?key=' + token + '&name=' + name + '\">重置密码链接</a>' +\n    '<p>若您没有在' + config.name + '社区填写过注册信息，说明有人滥用了您的电子邮箱，请删除此邮件，我们对给您造成的打扰感到抱歉。</p>' +\n    '<p>' + config.name + '社区 谨上。</p>';\n\n        await this.sendMail({\n            from,\n            to,\n            subject,\n            html\n        });\n    }\n}\n\nmodule.exports = MailService;\n\n"]}